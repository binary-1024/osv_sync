{
  "id": "CVE-2025-22034",
  "details": "In the Linux kernel, the following vulnerability has been resolved:\n\nmm/gup: reject FOLL_SPLIT_PMD with hugetlb VMAs\n\nPatch series \"mm: fixes for device-exclusive entries (hmm)\", v2.\n\nDiscussing the PageTail() call in make_device_exclusive_range() with\nWilly, I recently discovered [1] that device-exclusive handling does not\nproperly work with THP, making the hmm-tests selftests fail if THPs are\nenabled on the system.\n\nLooking into more details, I found that hugetlb is not properly fenced,\nand I realized that something that was bugging me for longer -- how\ndevice-exclusive entries interact with mapcounts -- completely breaks\nmigration/swapout/split/hwpoison handling of these folios while they have\ndevice-exclusive PTEs.\n\nThe program below can be used to allocate 1 GiB worth of pages and making\nthem device-exclusive on a kernel with CONFIG_TEST_HMM.\n\nOnce they are device-exclusive, these folios cannot get swapped out\n(proc$pid/smaps_rollup will always indicate 1 GiB RSS no matter how much\none forces memory reclaim), and when having a memory block onlined to\nZONE_MOVABLE, trying to offline it will loop forever and complain about\nfailed migration of a page that should be movable.\n\n# echo offline > /sys/devices/system/memory/memory136/state\n# echo online_movable > /sys/devices/system/memory/memory136/state\n# ./hmm-swap &\n... wait until everything is device-exclusive\n# echo offline > /sys/devices/system/memory/memory136/state\n[  285.193431][T14882] page: refcount:2 mapcount:0 mapping:0000000000000000\n  index:0x7f20671f7 pfn:0x442b6a\n[  285.196618][T14882] memcg:ffff888179298000\n[  285.198085][T14882] anon flags: 0x5fff0000002091c(referenced|uptodate|\n  dirty|active|owner_2|swapbacked|node=1|zone=3|lastcpupid=0x7ff)\n[  285.201734][T14882] raw: ...\n[  285.204464][T14882] raw: ...\n[  285.207196][T14882] page dumped because: migration failure\n[  285.209072][T14882] page_owner tracks the page as allocated\n[  285.210915][T14882] page last allocated via order 0, migratetype\n  Movable, gfp_mask 0x140dca(GFP_HIGHUSER_MOVABLE|__GFP_COMP|__GFP_ZERO),\n  id 14926, tgid 14926 (hmm-swap), ts 254506295376, free_ts 227402023774\n[  285.216765][T14882]  post_alloc_hook+0x197/0x1b0\n[  285.218874][T14882]  get_page_from_freelist+0x76e/0x3280\n[  285.220864][T14882]  __alloc_frozen_pages_noprof+0x38e/0x2740\n[  285.223302][T14882]  alloc_pages_mpol+0x1fc/0x540\n[  285.225130][T14882]  folio_alloc_mpol_noprof+0x36/0x340\n[  285.227222][T14882]  vma_alloc_folio_noprof+0xee/0x1a0\n[  285.229074][T14882]  __handle_mm_fault+0x2b38/0x56a0\n[  285.230822][T14882]  handle_mm_fault+0x368/0x9f0\n...\n\nThis series fixes all issues I found so far.  There is no easy way to fix\nwithout a bigger rework/cleanup.  I have a bunch of cleanups on top (some\nprevious sent, some the result of the discussion in v1) that I will send\nout separately once this landed and I get to it.\n\nI wish we could just use some special present PROT_NONE PTEs instead of\nthese (non-present, non-none) fake-swap entries; but that just results in\nthe same problem we keep having (lack of spare PTE bits), and staring at\nother similar fake-swap entries, that ship has sailed.\n\nWith this series, make_device_exclusive() doesn't actually belong into\nmm/rmap.c anymore, but I'll leave moving that for another day.\n\nI only tested this series with the hmm-tests selftests due to lack of HW,\nso I'd appreciate some testing, especially if the interaction between two\nGPUs wanting a device-exclusive entry works as expected.\n\n<program>\n#include <stdio.h>\n#include <fcntl.h>\n#include <stdint.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <string.h>\n#include <sys/mman.h>\n#include <sys/ioctl.h>\n#include <linux/types.h>\n#include <linux/ioctl.h>\n\n#define HMM_DMIRROR_EXCLUSIVE _IOWR('H', 0x05, struct hmm_dmirror_cmd)\n\nstruct hmm_dmirror_cmd {\n\t__u64 addr;\n\t__u64 ptr;\n\t__u64 npages;\n\t__u64 cpages;\n\t__u64 faults;\n};\n\nconst size_t size = 1 * 1024 * 1024 * 1024ul;\nconst size_t chunk_size = 2 * 1024 * 1024ul;\n\nint m\n---truncated---",
  "modified": "2025-05-05T17:54:03.714700Z",
  "published": "2025-04-16T15:15:56Z",
  "related": [
    "USN-7594-1",
    "USN-7594-2",
    "USN-7605-1",
    "USN-7606-1"
  ],
  "references": [
    {
      "type": "WEB",
      "url": "https://git.kernel.org/stable/c/2e877ff3492267def06dd50cb165dc9ab8838e7d"
    },
    {
      "type": "WEB",
      "url": "https://git.kernel.org/stable/c/48d28417c66cce2f3b0ba773fcb6695a56eff220"
    },
    {
      "type": "WEB",
      "url": "https://git.kernel.org/stable/c/8977752c8056a6a094a279004a49722da15bace3"
    },
    {
      "type": "WEB",
      "url": "https://git.kernel.org/stable/c/fd900832e8440046627b60697687ab5d04398008"
    },
    {
      "type": "ADVISORY",
      "url": "https://security-tracker.debian.org/tracker/CVE-2025-22034"
    }
  ],
  "affected": [
    {
      "package": {
        "name": "linux",
        "ecosystem": "Debian:13",
        "purl": "pkg:deb/debian/linux?arch=source"
      },
      "ranges": [
        {
          "type": "ECOSYSTEM",
          "events": [
            {
              "introduced": "0"
            },
            {
              "fixed": "6.12.25-1"
            }
          ]
        }
      ],
      "versions": [
        "6.1.106-1",
        "6.1.106-2",
        "6.1.106-3",
        "6.1.112-1",
        "6.1.115-1",
        "6.1.119-1",
        "6.1.123-1",
        "6.1.124-1",
        "6.1.128-1",
        "6.1.129-1",
        "6.1.133-1",
        "6.1.135-1",
        "6.1.27-1",
        "6.1.37-1",
        "6.1.38-1",
        "6.1.38-2",
        "6.1.38-2~bpo11+1",
        "6.1.38-3",
        "6.1.38-4",
        "6.1.38-4~bpo11+1",
        "6.1.52-1",
        "6.1.55-1",
        "6.1.55-1~bpo11+1",
        "6.1.64-1",
        "6.1.66-1",
        "6.1.67-1",
        "6.1.69-1",
        "6.1.69-1~bpo11+1",
        "6.1.76-1",
        "6.1.76-1~bpo11+1",
        "6.1.82-1",
        "6.1.85-1",
        "6.1.90-1",
        "6.1.90-1~bpo11+1",
        "6.1.94-1",
        "6.1.94-1~bpo11+1",
        "6.1.98-1",
        "6.1.99-1",
        "6.10-1~exp1",
        "6.10.1-1~exp1",
        "6.10.11-1",
        "6.10.11-1~bpo12+1",
        "6.10.12-1",
        "6.10.3-1",
        "6.10.4-1",
        "6.10.6-1",
        "6.10.6-1~bpo12+1",
        "6.10.7-1",
        "6.10.9-1",
        "6.11-1~exp1",
        "6.11.10-1",
        "6.11.10-1~bpo12+1",
        "6.11.2-1",
        "6.11.4-1",
        "6.11.5-1",
        "6.11.5-1~bpo12+1",
        "6.11.6-1",
        "6.11.7-1",
        "6.11.9-1",
        "6.11~rc4-1~exp1",
        "6.11~rc5-1~exp1",
        "6.12.10-1",
        "6.12.11-1",
        "6.12.11-1+alpha",
        "6.12.11-1+alpha.1",
        "6.12.12-1",
        "6.12.12-1~bpo12+1",
        "6.12.13-1",
        "6.12.15-1",
        "6.12.16-1",
        "6.12.17-1",
        "6.12.19-1",
        "6.12.20-1",
        "6.12.21-1",
        "6.12.22-1",
        "6.12.22-1~bpo12+1",
        "6.12.3-1",
        "6.12.5-1",
        "6.12.6-1",
        "6.12.8-1",
        "6.12.9-1",
        "6.12.9-1+alpha",
        "6.12.9-1~bpo12+1",
        "6.12~rc6-1~exp1",
        "6.3.1-1~exp1",
        "6.3.11-1",
        "6.3.2-1~exp1",
        "6.3.4-1~exp1",
        "6.3.5-1~exp1",
        "6.3.7-1",
        "6.3.7-1~bpo12+1",
        "6.4.1-1~exp1",
        "6.4.11-1",
        "6.4.13-1",
        "6.4.4-1",
        "6.4.4-1~bpo12+1",
        "6.4.4-2",
        "6.4.4-3",
        "6.4.4-3~bpo12+1",
        "6.4~rc6-1~exp1",
        "6.4~rc7-1~exp1",
        "6.5.1-1~exp1",
        "6.5.10-1",
        "6.5.10-1~bpo12+1",
        "6.5.13-1",
        "6.5.3-1",
        "6.5.3-1~bpo12+1",
        "6.5.6-1",
        "6.5.8-1",
        "6.5~rc4-1~exp1",
        "6.5~rc6-1~exp1",
        "6.5~rc7-1~exp1",
        "6.6.11-1",
        "6.6.13-1",
        "6.6.13-1~bpo12+1",
        "6.6.15-1",
        "6.6.15-2",
        "6.6.3-1~exp1",
        "6.6.4-1~exp1",
        "6.6.7-1~exp1",
        "6.6.8-1",
        "6.6.9-1",
        "6.7-1~exp1",
        "6.7.1-1~exp1",
        "6.7.12-1",
        "6.7.12-1~bpo12+1",
        "6.7.4-1~exp1",
        "6.7.7-1",
        "6.7.9-1",
        "6.7.9-2",
        "6.8.11-1",
        "6.8.12-1",
        "6.8.12-1~bpo12+1",
        "6.8.9-1",
        "6.9.10-1",
        "6.9.10-1~bpo12+1",
        "6.9.11-1",
        "6.9.12-1",
        "6.9.2-1~exp1",
        "6.9.7-1",
        "6.9.7-1~bpo12+1",
        "6.9.8-1",
        "6.9.9-1"
      ],
      "ecosystem_specific": {
        "urgency": "not yet assigned"
      },
      "database_specific": {
        "source": "https://storage.googleapis.com/cve-osv-conversion/osv-output/CVE-2025-22034.json"
      }
    }
  ],
  "schema_version": "1.6.0"
}